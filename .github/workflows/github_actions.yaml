name: SnowForm Workflow
run-name: ${{ github.actor }} is testing updates for a SnowForm Terraform Module ðŸš€
on: [push]
env:
  TFDIR: terraform

jobs:
  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache TFLint plugin dir
        uses: actions/cache@v3
        with:
          path: ~/.tflint.d/plugins
          key: tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Show version
        run: tflint --version

      - name: CD TFDIR
        run: cd $TFDIR

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive

  terraform-fmt:
    name: Terraform Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.9.0

      - name: CD TFDIR
        run: cd $TFDIR

      - name: Terraform Format Check
        run: tofu fmt -check -recursive

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.9.0

      - name: CD TFDIR
        run: cd $TFDIR

      - name: OpenTofu init
        run: tofu init

      - name: Run OpenTofu Tests
        run: tofu test

  kics-scan:
    name: KICS Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run KICS Scan
        uses: checkmarx/kics-github-action@v2.1.14
        with:
          path: '.'
          fail_on: high,critical
          output_formats: 'json'
          output_path: 'kics-results.json'
          disable_progress_bar: true

      - name: Upload KICS results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kics-results.json
          path: kics-results.json

  tofu-validate:
    name: OpenTofu Validate
    needs: [tflint, terraform-fmt, unit-test, kics-scan]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.9.0

      - name: CD TFDIR
        run: cd $TFDIR

      - name: OpenTofu Init
        run: tofu init

      - name: OpenTofu Validate
        run: tofu validate

  tofu-plan:
    name: OpenTofu Plan
    needs: [tofu-validate]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.9.0

      - name: CD TFDIR
        run: cd $TFDIR

      - name: OpenTofu Init
        run: tofu init

      - name: OpenTofu Plan
        run: tofu plan -out=tfplan
        
      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan

  tofu-apply:
    name: OpenTofu Apply
    needs: [tofu-plan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Only run on main branch
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.9.0

      - name: CD TFDIR
        run: cd $TFDIR

      - name: OpenTofu Init
        run: tofu init

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan

      - name: OpenTofu Apply
        run: tofu apply -auto-approve tfplan
